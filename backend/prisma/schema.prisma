generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]  
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String               @id @default(uuid())
  login                 String               @unique
  password              String
  email                 String?
  stripeAccount         String?
  role                  String               @default("employee")
  confidentialityPolicy String?
  paymentMode           String?              @default("onsite_only")
  depositType           String?
  depositAmount         Float?
  practiceActivities    String[]
  teamName              String?
  teamLeaderId          String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  phone                 String?
  twoFactorEnabled      Boolean              @default(true)
  activityFormConfigs   ActivityFormConfig[]
  emailTemplates        EmailTemplate[]
  equipmentLists        EquipmentList[]      @relation("UserEquipmentLists")
  giftVouchers          GiftVoucher[]
  newsletters           Newsletter[]
  passwordResets        PasswordReset[]
  products              Product[]
  resellers             Reseller[]
  sessions              Session[]
  settings              Settings?
  trustedDevices        TrustedDevice[]
  twoFactorCodes        TwoFactorCode[]
  teamLeader            User?                @relation("TeamHierarchy", fields: [teamLeaderId], references: [id])
  teamMembers           User[]               @relation("TeamHierarchy")

  @@map("users")
}

model Category {
  id          String            @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  products    ProductCategory[]

  @@map("categories")
}

model Product {
  id                   String            @id @default(uuid())
  name                 String
  shortDescription     String?
  longDescription      String?
  priceIndividual      Float
  priceGroup           Json?
  duration             Int
  color                String
  level                String
  region               String            @default("annecy")
  maxCapacity          Int
  autoCloseHoursBefore Int?
  postBookingMessage   String?
  wazeLink             String?
  googleMapsLink       String?
  websiteLink          String?
  images               String[]
  activityTypeId       String
  guideId              String
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  equipmentListId      String?
  meetingPoint         String?
  bookings             Booking[]
  categories           ProductCategory[]
  equipmentList        EquipmentList?    @relation(fields: [equipmentListId], references: [id])
  guide                User              @relation(fields: [guideId], references: [id], onDelete: Cascade)
  sessionProducts      SessionProduct[]

  @@map("products")
}

model Session {
  id                  String           @id @default(uuid())
  date                DateTime
  timeSlot            String
  startTime           String
  isMagicRotation     Boolean          @default(false)
  status              String           @default("open")
  shoeRentalAvailable Boolean          @default(false)
  shoeRentalPrice     Float?
  guideId             String
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  bookings            Booking[]
  products            SessionProduct[]
  guide               User             @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model SessionProduct {
  id               String   @id @default(uuid())
  sessionId        String
  productId        String
  createdAt        DateTime @default(now())
  productOverrides Json?
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  session          Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, productId])
  @@map("session_products")
}

model ProductCategory {
  id         String   @id @default(uuid())
  productId  String
  categoryId String
  createdAt  DateTime @default(now())
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@map("product_categories")
}

model Reseller {
  id         String    @id @default(uuid())
  name       String
  email      String?
  phone      String?
  website    String?
  commission Float?
  notes      String?
  userId     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  bookings   Booking[]
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("resellers")
}

model Booking {
  id                        String           @id @default(uuid())
  clientFirstName           String
  clientLastName            String
  clientEmail               String
  clientPhone               String
  clientNationality         String?
  numberOfPeople            Int
  totalPrice                Float
  amountPaid                Float            @default(0)
  status                    String           @default("pending")
  cancellationReason        String?
  cancelledAt               DateTime?
  voucherCode               String?
  discountAmount            Float?
  participantsFormCompleted Boolean          @default(false)
  productDetailsSent        Boolean          @default(false)
  resellerId                String?
  sessionId                 String
  productId                 String
  createdAt                 DateTime         @default(now())
  updatedAt                 DateTime         @updatedAt
  history                   BookingHistory[]
  notes                     BookingNote[]
  product                   Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  reseller                  Reseller?        @relation(fields: [resellerId], references: [id])
  session                   Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participants              Participant[]
  payments                  Payment[]

  @@map("bookings")
}

model Payment {
  id             String   @id @default(uuid())
  amount         Float
  method         String
  stripeId       String?
  voucherCode    String?
  discountAmount Float?
  notes          String?
  bookingId      String
  createdAt      DateTime @default(now())
  booking        Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model BookingHistory {
  id        String   @id @default(uuid())
  action    String
  details   String?
  bookingId String
  createdAt DateTime @default(now())
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_history")
}

model GiftVoucher {
  id             String           @id @default(uuid())
  code           String           @unique
  amount         Float
  discountType   String           @default("fixed")
  type           String           @default("voucher")
  maxUsages      Int?
  usageCount     Int              @default(0)
  notes          String?
  userId         String
  createdAt      DateTime         @default(now())
  expiresAt      DateTime?
  buyerEmail     String?
  message        String?
  recipientEmail String?
  recipientName  String?
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  usages         PromoCodeUsage[]

  @@map("gift_vouchers")
}

model PromoCodeUsage {
  id        String      @id @default(uuid())
  voucherId String
  usedBy    String?
  bookingId String?
  usedAt    DateTime    @default(now())
  voucher   GiftVoucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  @@map("promo_code_usages")
}

model Participant {
  id            String   @id @default(uuid())
  firstName     String
  age           Int?
  height        Int?
  weight        Float?
  wetsuitSize   String?
  shoeRental    Boolean  @default(false)
  shoeSize      Int?
  practiceLevel String?
  comment       String?
  isComplete    Boolean  @default(false)
  bookingId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("participants")
}

model BookingNote {
  id        String   @id @default(uuid())
  content   String
  bookingId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_notes")
}

model EmailTemplate {
  id          String   @id @default(uuid())
  type        String
  name        String
  subject     String
  htmlContent String
  textContent String?
  variables   String?
  isActive    Boolean  @default(true)
  userId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([userId, type])
  @@map("email_templates")
}

model Settings {
  id                       String   @id @default(uuid())
  companyName              String?
  companyPhone             String?
  companyEmail             String?
  website                  String?
  logo                     String?
  slogan                   String?
  primaryColor             String?
  secondaryColor           String?
  clientButtonColor        String?
  clientAccentColor        String?
  confirmationRedirectUrl  String?
  userId                   String   @unique
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("settings")
}

model Newsletter {
  id             String    @id @default(uuid())
  email          String    @unique
  acceptedTerms  Boolean   @default(true)
  isActive       Boolean   @default(true)
  firstName      String?
  lastName       String?
  source         String?
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  userId         String?
  user           User?     @relation(fields: [userId], references: [id])

  @@map("newsletter")
}

model EquipmentList {
  id        String    @id @default(uuid())
  name      String
  items     String
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation("UserEquipmentLists", fields: [userId], references: [id], onDelete: Cascade)
  products  Product[]

  @@map("equipment_lists")
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model TwoFactorCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  tempToken String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_codes")
}

model TrustedDevice {
  id          String   @id @default(uuid())
  userId      String
  jti         String?   @unique 
  deviceName  String?
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  lastUsedAt  DateTime @default(now())
  revoked     Boolean  @default(false)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("trusted_devices")
}

model ActivityFormConfig {
  id             String   @id @default(uuid())
  activityTypeId String   // 'canyoning', 'escalade', 'via-ferrata', 'speleologie'
  userId         String
  fields         Json     // Configuration des champs du formulaire
  wetsuitBrand   String?  // Marque de combinaison (uniquement pour canyoning)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([activityTypeId, userId])
  @@map("activity_form_configs")
}

// Table temporaire pour stocker les données de réservation pendant le paiement
// (contourne la limite de 500 caractères des metadata Stripe)
model PendingBooking {
  id           String   @id @default(uuid())
  sessionId    String
  productId    String
  bookingData  Json     // Données client (nom, email, etc.)
  participants Json?    // Données participants (optionnel)
  totalAmount  Float
  isDeposit    Boolean  @default(false)
  expiresAt    DateTime // Expiration après 1h
  createdAt    DateTime @default(now())

  @@map("pending_bookings")
}
