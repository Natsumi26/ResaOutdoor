// Schéma Prisma pour le logiciel de réservation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Utilisateurs/Guides
model User {
  id            String    @id @default(uuid())
  login         String    @unique
  password      String
  email         String?
  stripeAccount String?   // Compte Stripe associé
  role          String    @default("employee") // "super_admin", "leader", "employee", "trainee"

  // Hiérarchie de team
  teamName      String?   // Nom de l'équipe (uniquement pour les leaders)
  teamLeaderId  String?   // Leader de l'équipe (null si l'utilisateur est lui-même leader ou super_admin)
  teamLeader    User?     @relation("TeamHierarchy", fields: [teamLeaderId], references: [id], onDelete: SetNull)
  teamMembers   User[]    @relation("TeamHierarchy") // Membres de l'équipe si l'utilisateur est leader

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  products       Product[]
  sessions       Session[]
  emailTemplates EmailTemplate[]
  giftVouchers   GiftVoucher[]
  resellers      Reseller[]

  @@map("users")
}

// Catégories d'activités
model Category {
  id          String    @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    ProductCategory[]

  @@map("categories")
}

// Produits/Activités (modèles de canyon)
model Product {
  id                    String   @id @default(uuid())
  name                  String
  shortDescription      String?
  longDescription       String?
  priceIndividual       Float
  priceGroup            Json?    // Règles de prix groupe: {min: 5, price: 45}
  duration              Int      // Durée en minutes
  color                 String   // Code couleur hex
  level                 String   // "découverte", "aventure", "sportif"
  region                String   @default("annecy") // "annecy" ou "grenoble"
  maxCapacity           Int
  autoCloseHoursBefore  Int?     // Fermeture auto X heures avant
  postBookingMessage    String?
  wazeLink              String?
  googleMapsLink        String?
  websiteLink           String?  // Lien vers la page internet du produit
  images                String[] // URLs des images

  guideId               String
  guide                 User     @relation(fields: [guideId], references: [id], onDelete: Cascade)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  categories            ProductCategory[]
  sessionProducts       SessionProduct[]
  bookings              Booking[]

  @@map("products")
}

// Sessions (créneaux planifiés)
model Session {
  id                    String      @id @default(uuid())
  date                  DateTime
  timeSlot              String      // "matin", "après-midi" ou "journée"
  startTime             String      // "09:00"
  isMagicRotation       Boolean     @default(false)
  status                String      @default("open") // "open", "full", "closed"
  shoeRentalAvailable   Boolean     @default(false) // Location de chaussures disponible
  shoeRentalPrice       Float?      // Prix de location de chaussures

  guideId               String
  guide                 User        @relation(fields: [guideId], references: [id], onDelete: Cascade)

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  // Relations
  products              SessionProduct[]  // Produits disponibles dans cette session
  bookings              Booking[]

  @@map("sessions")
}

// Table de jonction : Produits disponibles dans une session
// Permet la rotation magique (plusieurs produits par session)
model SessionProduct {
  id        String   @id @default(uuid())

  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([sessionId, productId])
  @@map("session_products")
}

// Table de jonction : Catégories associées à un produit
// Permet à un produit d'avoir plusieurs catégories ou aucune
model ProductCategory {
  id         String   @id @default(uuid())

  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([productId, categoryId])
  @@map("product_categories")
}

// Revendeurs
model Reseller {
  id          String    @id @default(uuid())
  name        String
  email       String?
  phone       String?
  website     String?   // Lien vers le site web du revendeur
  commission  Float?    // Commission en pourcentage (optionnel)
  notes       String?

  // Propriétaire du revendeur
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  bookings    Booking[]

  @@map("resellers")
}

// Réservations
model Booking {
  id                        String      @id @default(uuid())

  // Client
  clientFirstName           String
  clientLastName            String
  clientEmail               String
  clientPhone               String
  clientNationality         String?

  // Réservation
  numberOfPeople            Int
  totalPrice                Float
  amountPaid                Float       @default(0)
  status                    String      @default("pending") // "pending", "confirmed", "cancelled"

  // Annulation
  cancellationReason        String?     // Raison de l'annulation
  cancelledAt               DateTime?   // Date d'annulation

  // Code promo / Bon cadeau utilisé
  voucherCode               String?     // Code du bon cadeau ou promo utilisé
  discountAmount            Float?      // Montant de la réduction appliquée

  // Statuts de complétion pour le badge
  participantsFormCompleted Boolean     @default(false) // Le formulaire participants est complété
  productDetailsSent        Boolean     @default(false) // Les détails du produit ont été envoyés par le guide

  // Revendeur (optionnel)
  resellerId                String?
  reseller                  Reseller?   @relation(fields: [resellerId], references: [id], onDelete: SetNull)

  // Relations : Le client réserve pour UN produit (canyon) spécifique
  sessionId                 String
  session                   Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  productId                 String
  product                   Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt

  payments                  Payment[]
  history                   BookingHistory[]
  participants              Participant[]
  notes                     BookingNote[]

  @@map("bookings")
}

// Paiements
model Payment {
  id            String   @id @default(uuid())
  amount        Float
  method        String   // "CB", "virement", "espèces", "stripe"
  stripeId      String?  // ID transaction Stripe
  voucherCode   String?  // Code promo/bon cadeau utilisé pour ce paiement
  discountAmount Float?  // Montant de réduction appliqué
  notes         String?

  bookingId     String
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@map("payments")
}

// Historique des modifications de réservation
model BookingHistory {
  id          String   @id @default(uuid())
  action      String   // "created", "modified", "payment", "cancelled"
  details     String?

  bookingId   String
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@map("booking_history")
}

// Bons cadeaux / Codes promos
model GiftVoucher {
  id            String              @id @default(uuid())
  code          String              @unique
  amount        Float               // Montant de réduction (en € ou en %)
  discountType  String              @default("fixed") // "fixed" (montant fixe) ou "percentage" (pourcentage)
  type          String              @default("voucher") // "voucher" (à usage unique) ou "promo" (utilisations multiples)
  maxUsages     Int?                // Nombre max d'utilisations (null = illimité)
  usageCount    Int                 @default(0) // Nombre d'utilisations actuelles
  notes         String?             // Notes (utilisé pour stocker le payment_intent Stripe)

  // Propriétaire du bon cadeau
  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime            @default(now())
  expiresAt     DateTime?

  usages        PromoCodeUsage[]    // Historique des utilisations

  @@map("gift_vouchers")
}

// Historique d'utilisation des codes promos
model PromoCodeUsage {
  id            String       @id @default(uuid())

  voucherId     String
  voucher       GiftVoucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  usedBy        String?      // Email ou nom du client
  bookingId     String?      // Lien vers la réservation si applicable

  usedAt        DateTime     @default(now())

  @@map("promo_code_usages")
}

// Participants (informations sur chaque participant d'une réservation)
model Participant {
  id            String   @id @default(uuid())

  firstName     String
  age           Int?
  height        Int?      // Taille en cm
  weight        Float?    // Poids en kg
  wetsuitSize   String?  // Taille de combinaison calculée automatiquement
  shoeRental    Boolean  @default(false) // Location de chaussures pour ce participant
  shoeSize      Int?     // Pointure si location de chaussures
  isComplete    Boolean @default(false)

  bookingId     String
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("participants")
}

// Notes de réservation
model BookingNote {
  id          String   @id @default(uuid())
  content     String   // Contenu de la note

  bookingId   String
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("booking_notes")
}

// Templates d'emails
// Système de templates avec copy-on-write :
// - userId = null : template global partagé par tous les utilisateurs
// - userId = <id> : template personnalisé pour un utilisateur spécifique
// Lors de la récupération : chercher d'abord le template personnalisé, sinon utiliser le global
// Lors de la modification : si le template est global, créer une copie personnalisée
model EmailTemplate {
  id          String   @id @default(uuid())
  type        String   // "booking_confirmation", "booking_reminder", "payment_confirmation", etc.
  name        String   // Nom du template (ex: "Confirmation de réservation")
  subject     String   // Sujet de l'email
  htmlContent String   @db.Text // Contenu HTML du template
  textContent String?  @db.Text // Version texte (optionnel)
  variables   String?  @db.Text // Liste des variables disponibles (JSON)
  isActive    Boolean  @default(true)

  userId      String?  // NULL = template global, sinon = template personnalisé pour cet utilisateur
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])           // Index pour recherche rapide des templates globaux
  @@index([userId, type])   // Index pour recherche rapide des templates personnalisés
  @@map("email_templates")
}

// Paramètres globaux de l'application
model Settings {
  id              String   @id @default(uuid())
  companyName     String?  // Nom de l'entreprise
  companyPhone    String?  // Téléphone de l'entreprise
  companyEmail    String?  // Email de l'entreprise
  website         String?  // Site internet de l'entreprise
  logo            String?  // URL du logo
  primaryColor    String?  // Couleur principale
  secondaryColor  String?  // Couleur secondaire

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("settings")
}
